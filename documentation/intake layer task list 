
PHASE 1 — Episode ambiguity detection (read-only, no control authority yet)

11. Implement real Episode Hypothesis Generator (EHG v1)

This is the first place meaning enters the system.

Work
Replace stub with real LLM call.

Inputs:
Raw user utterance
Confirmed episode descriptors (symptom class, rough onset, laterality if known)
Outputs only the structured signal:

hypothesis_count
hypothesis_count_confidence_band 
pivot_detected
pivot_detected confidence_band 

Hard constraints
No episode IDs
No state writes
No orchestration decisions
Conservative bias
Exit condition
EHG outputs are stable and auditable in logs.
Dialogue flow is unchanged.

---

12. Pivot handling (mechanical, policy-only)

This is orthogonal and should be done early.

Work

Enforce pivot rules:

EXTRACTION → DISCOVERY

CLARIFICATION → DISCOVERY
Discard clarification buffer on pivot.
Ignore pivot in DISCOVERY.
Why now
Pivot is a safety escape hatch.
It must work before clarification logic is trusted.
Exit condition
Pivot never corrupts episode state.

---

PHASE 2 — Clarification Parser and evidence discipline

13. Implement Clarification Parser (CP)

This is constrained NLP, not clinical extraction.
Work
LLM extracts:
Mention Objects
relation_hypothesis
Every mention must include:
verbatim evidence span
Hard constraints
No state writes
No episode resolution
No question generation
Exit condition
CP outputs fail safely (discarded) when spans don’t validate.
No hallucinated spans survive.

---

14. Enforce Evidence-Span Validation Gate
You already built the validator. Now it becomes authoritative.
Work
Orchestrator validates all CP outputs.
On failure:
discard CP output
fall back to generic clarification template
Exit condition
No CP-derived content reaches the user unless span-valid.

---

PHASE 3 — Clarification loop (mode-controlled, no replay yet)

15. MODE_CLARIFICATION activation and blocking
This is where modes start to matter.
Work
If EHG.ambiguity_detected:
switch to MODE_CLARIFICATION
block RP commits
EHG becomes passive except for pivot detection.
Invariant
RP writes are illegal in MODE_CLARIFICATION.
Exit condition
No clinical data enters state during clarification.

---

16. Deterministic clarification question selection
Now use the templates you already built.
Work
Choose template based on:
relation_hypothesis
number of mentions
Fill templates using Mention Objects only.
Hard rule
No new clinical concepts introduced.
Exit condition
Clarification questions are fully auditable and reproducible.

---

PHASE 4 — Resolution authority and forced outcomes

17. Resolution authority enforcement
Clarification must end deterministically.
Work
Only CP output or explicit user confirmation can resolve ambiguity.
EHG confidence spikes are ignored in clarification.
Exit condition
No “floating” hypotheses exist beyond clarification.

---

18. Forced resolution logic (Give-Up)
This is policy, not NLP.
Work
Track clarification attempt count.
Apply one of:
Separation Protocol
Continuity Protocol
Limbo / Isolation Protocol
Record:
policy applied
epistemic status
Exit condition
System always exits clarification in bounded time.

---

PHASE 5 — Replay (high risk, tightly scoped)

19. Clarification Transcript population
You already created the buffer; now populate it correctly.
Work
Record:
system template ID
raw user response
replayable flag
Mark episode-structural questions as non-replayable.
Exit condition
Buffer content is deterministic and minimal.

---

20. RP Replay execution
This is the most dangerous step. Do it late.
Work
On clarification exit:
construct synthetic RP input:
episode anchor
resolution status
applied policy
filtered transcript
Enforce:
no replay on negation
no raw transcript injection
single RP call only
Exit condition
Replay never creates or resolves episodes.
Replay cannot override forced policy.

---

PHASE 6 — Episode semantics completion

21. Episode creation / merge / limbo handling
Now semantics are allowed.
Work
Create or merge episode per resolution outcome.
Limbo episodes:
write-only
no question selection
confidence LOW
Exit condition
Episode list is always internally consistent.

---

22. Mode transition hardening
Lock invariants.
Work
Assert illegal transitions crash loudly in dev.
Examples:
RP commit in DISCOVERY
Replay without resolution
Clarification exit without resolution or force
Exit condition
Violations are impossible silently.

---

PHASE 7 — Cleanup and hardening

23. Remove legacy assumptions
Delete or neuter code that assumes:
exactly one episode
linear questioning
RP always runs

---

24. Failure-mode testing
This is not optional.
Required tests
Ambiguous multi-episode utterance
Repeated failure to clarify
Pivot mid-clarification
Contradictory clarification answers
Replay after forced separation